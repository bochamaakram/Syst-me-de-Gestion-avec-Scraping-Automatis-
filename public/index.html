<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Learning | knowway</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .filters-row {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
            margin-bottom: var(--space-lg);
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 10px 16px 10px 40px;
        }

        .search-box::before {
            content: 'üîç';
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">knowway</a>
            <div class="navbar-search">
                <input type="text" id="globalSearch" placeholder="Search for anything">
            </div>
            <ul class="navbar-nav">
                <li><a href="hub.html">Explore</a></li>
                <li><a href="index.html" style="color:var(--primary)">My Learning</a></li>
            </ul>
            <div class="navbar-user" id="navbarUser"></div>
        </div>
    </nav>

    <section class="learning-hero">
        <div class="container">
            <h1>My Learning</h1>
        </div>
    </section>

    <main class="container">
        <!-- Filters -->
        <div class="filters-row">
            <div class="search-box">
                <input type="text" id="searchInput" class="form-control" placeholder="Search my courses...">
            </div>
            <select id="categoryFilter" class="form-control" style="width:auto">
                <option value="">All Categories</option>
                <option value="dev">Development</option>
                <option value="design">Design</option>
                <option value="marketing">Marketing</option>
            </select>
            <select id="progressFilter" class="form-control" style="width:auto">
                <option value="">All Progress</option>
                <option value="not-started">Not Started</option>
                <option value="in-progress">In Progress</option>
                <option value="completed">Completed</option>
            </select>
        </div>

        <p id="resultsCount" class="results-count" style="display:none"></p>

        <div id="loadingState" class="empty-state">
            <div class="spinner"></div>
        </div>

        <div id="myCourses" style="display:none"></div>

        <div id="emptyState" class="empty-learning" style="display:none">
            <h2>Start learning!</h2>
            <p>When you purchase a course, it will appear here. Ready to start?</p>
            <a href="hub.html" class="btn btn-primary btn-lg">Browse courses</a>
        </div>

        <div id="noResults" class="empty-learning" style="display:none">
            <h2>No courses found</h2>
            <p>Try adjusting your filters</p>
            <button class="btn btn-secondary" onclick="clearFilters()">Clear filters</button>
        </div>

        <div id="loginPrompt" class="empty-learning" style="display:none">
            <h2>Log in to view your courses</h2>
            <p>Sign in to access your purchased courses</p>
            <a href="login.html" class="btn btn-primary btn-lg">Log in</a>
        </div>
    </main>

    <div id="toastContainer" class="toast-container"></div>
    <script src="app.js"></script>
    <script>
        let allPurchases = [];
        let filters = { search: '', category: '', progress: '' };

        document.addEventListener('DOMContentLoaded', async () => {
            updateNavbar();
            setupFilters();
            await loadMyCourses();
        });

        function updateNavbar() {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('navbarUser').innerHTML = user
                ? `<a href="dashboard.html"><button class="btn btn-sm" style="background:var(--primary);color:var(--crust);width:40px;height:40px;border-radius:var(--radius-full);font-weight:700;cursor:pointer;">${user.username.charAt(0).toUpperCase()}</button></a>`
                : `<a href="login.html" class="btn btn-secondary btn-sm">Log in</a><a href="login.html" class="btn btn-primary btn-sm">Sign up</a>`;
        }

        function setupFilters() {
            document.getElementById('searchInput').addEventListener('input', debounce(e => {
                filters.search = e.target.value.toLowerCase();
                applyFilters();
            }, 300));

            document.getElementById('categoryFilter').addEventListener('change', e => {
                filters.category = e.target.value;
                applyFilters();
            });

            document.getElementById('progressFilter').addEventListener('change', e => {
                filters.progress = e.target.value;
                applyFilters();
            });

            document.getElementById('globalSearch').addEventListener('keypress', e => {
                if (e.key === 'Enter') window.location.href = 'hub.html?search=' + encodeURIComponent(e.target.value);
            });
        }

        function clearFilters() {
            filters = { search: '', category: '', progress: '' };
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('progressFilter').value = '';
            applyFilters();
        }

        async function loadMyCourses() {
            document.getElementById('loadingState').style.display = 'none';

            if (!localStorage.getItem('token')) {
                document.getElementById('loginPrompt').style.display = 'block';
                return;
            }

            try {
                const res = await api.getMyPurchases();
                if (res.success && res.purchases.length > 0) {
                    allPurchases = res.purchases;
                    applyFilters();
                } else {
                    document.getElementById('emptyState').style.display = 'block';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function applyFilters() {
            let filtered = [...allPurchases];

            // Search filter
            if (filters.search) {
                filtered = filtered.filter(c =>
                    c.title.toLowerCase().includes(filters.search) ||
                    (c.author && c.author.toLowerCase().includes(filters.search))
                );
            }

            // Category filter
            if (filters.category) {
                filtered = filtered.filter(c => c.category === filters.category);
            }

            // Progress filter
            if (filters.progress) {
                filtered = filtered.filter(c => {
                    const progress = c.progress || 0;
                    if (filters.progress === 'not-started') return progress === 0;
                    if (filters.progress === 'in-progress') return progress > 0 && progress < 100;
                    if (filters.progress === 'completed') return progress === 100;
                    return true;
                });
            }

            renderCourses(filtered);
        }

        function renderCourses(courses) {
            const container = document.getElementById('myCourses');
            const noResults = document.getElementById('noResults');
            const resultsCount = document.getElementById('resultsCount');

            if (courses.length === 0) {
                container.style.display = 'none';
                noResults.style.display = 'block';
                resultsCount.style.display = 'none';
                return;
            }

            noResults.style.display = 'none';
            container.style.display = 'block';
            resultsCount.style.display = 'block';
            resultsCount.textContent = `${courses.length} course${courses.length !== 1 ? 's' : ''}`;

            container.innerHTML = courses.map(c => {
                const progress = c.progress || 0;
                const categoryLabel = { dev: 'Development', design: 'Design', marketing: 'Marketing' }[c.category] || c.category;
                return `
                <div class="course-card-enrolled" onclick="window.location.href='course.html?id=${c.id}'">
                    <img src="${c.image_url || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=400'}" onerror="this.src='https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=400'">
                    <div class="course-card-enrolled-content">
                        <div class="course-card-enrolled-title">${escapeHtml(c.title)}</div>
                        <div class="course-card-enrolled-instructor">${escapeHtml(c.author || 'Instructor')} ¬∑ ${categoryLabel}</div>
                        <div class="progress-container">
                            <div class="progress-bar"><div class="progress-bar-fill" style="width:${progress}%"></div></div>
                            <div class="progress-text">${progress}% complete</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
    </script>
</body>

</html>
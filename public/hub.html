<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Courses | knowway</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .add-to-cart-btn {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all var(--transition);
        }

        .add-to-cart-btn:hover {
            background: var(--primary-dark);
        }

        .add-to-cart-btn.in-cart {
            background: var(--success);
        }

        .add-to-cart-btn.owned {
            background: var(--success);
            cursor: pointer;
        }

        .add-to-cart-btn:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        .cart-badge {
            background: var(--primary);
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">knowway</a>
            <div class="navbar-search">
                <input type="text" id="searchInput" placeholder="Search for anything">
            </div>
            <ul class="navbar-nav">
                <li><a href="hub.html" style="color:var(--primary)">Explore</a></li>
                <li><a href="index.html">My Learning <span class="cart-badge" id="cartBadge"
                            style="display:none">0</span></a></li>
            </ul>
            <div class="navbar-user" id="navbarUser"></div>
        </div>
    </nav>

    <div class="search-section">
        <div class="container">
            <div class="filter-row">
                <select id="levelFilter" class="form-control"
                    style="width:auto;padding:10px 36px 10px 16px;border-radius:var(--radius-xl);">
                    <option value="">All Levels</option>
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                </select>
                <select id="priceFilter" class="form-control"
                    style="width:auto;padding:10px 36px 10px 16px;border-radius:var(--radius-xl);">
                    <option value="">All Prices</option>
                    <option value="free">Free</option>
                    <option value="paid">Paid</option>
                </select>
                <select id="sortFilter" class="form-control"
                    style="width:auto;padding:10px 36px 10px 16px;border-radius:var(--radius-xl);">
                    <option value="newest">Newest</option>
                    <option value="popular">Most Popular</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                </select>
            </div>
        </div>
    </div>

    <main class="container" style="padding: 24px;">
        <div class="filter-row" style="margin-bottom: 24px;">
            <button class="filter-btn active" data-category="">All Courses</button>
            <button class="filter-btn" data-category="dev">Development</button>
            <button class="filter-btn" data-category="design">Design</button>
            <button class="filter-btn" data-category="marketing">Marketing</button>
        </div>

        <p class="results-count" id="resultsCount">0 results</p>

        <div id="coursesGrid" class="courses-grid"></div>
        <div id="loadingState" class="empty-state">
            <div class="spinner"></div>
        </div>
        <div id="emptyState" class="empty-state hidden">
            <h3>No courses found</h3>
            <p>Try adjusting your filters</p>
        </div>

        <div id="pagination" class="pagination hidden">
            <button id="prevBtn" class="pagination-btn">&lt;</button>
            <span id="paginationInfo" class="pagination-info"></span>
            <button id="nextBtn" class="pagination-btn">&gt;</button>
        </div>
    </main>

    <div id="toastContainer" class="toast-container"></div>
    <script src="app.js"></script>
    <script>
        let allCourses = [], filteredCourses = [], currentPage = 1, favoriteIds = [], purchasedIds = [];
        const limit = 12;
        let filters = { search: '', category: '', level: '', price: '', sort: 'newest' };

        document.addEventListener('DOMContentLoaded', async () => {
            updateNavbar();

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('search')) {
                filters.search = urlParams.get('search').toLowerCase();
                document.getElementById('searchInput').value = urlParams.get('search');
            }

            await loadUserData();
            await loadAllCourses();
            setupEventListeners();
        });

        function updateNavbar() {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('navbarUser').innerHTML = user
                ? `<a href="dashboard.html"><button class="btn btn-sm" style="background:var(--secondary);color:white;width:40px;height:40px;border-radius:50%;font-weight:700;cursor:pointer;">${user.username.charAt(0).toUpperCase()}</button></a>`
                : `<a href="login.html" class="btn btn-secondary btn-sm">Log in</a><a href="login.html" class="btn btn-dark btn-sm">Sign up</a>`;
        }

        async function loadUserData() {
            if (!localStorage.getItem('token')) return;
            try {
                const [favRes, purchRes] = await Promise.all([
                    api.getMyFavoriteIds(),
                    api.getMyPurchaseIds()
                ]);
                if (favRes.success) favoriteIds = favRes.favoriteIds;
                if (purchRes.success) {
                    purchasedIds = purchRes.purchaseIds;
                    updateCartBadge();
                }
            } catch (e) { console.error(e); }
        }

        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            if (purchasedIds.length > 0) {
                badge.textContent = purchasedIds.length;
                badge.style.display = 'inline';
            } else {
                badge.style.display = 'none';
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('[data-category]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-category]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    filters.category = btn.dataset.category;
                    applyFilters();
                });
            });
            document.getElementById('searchInput').addEventListener('input', debounce((e) => { filters.search = e.target.value.toLowerCase(); applyFilters(); }, 300));
            document.getElementById('levelFilter').addEventListener('change', (e) => { filters.level = e.target.value; applyFilters(); });
            document.getElementById('priceFilter').addEventListener('change', (e) => { filters.price = e.target.value; applyFilters(); });
            document.getElementById('sortFilter').addEventListener('change', (e) => { filters.sort = e.target.value; applyFilters(); });
            document.getElementById('prevBtn').addEventListener('click', () => { currentPage--; renderCurrentPage(); });
            document.getElementById('nextBtn').addEventListener('click', () => { currentPage++; renderCurrentPage(); });
        }

        async function loadAllCourses() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('coursesGrid').classList.add('hidden');
            try {
                const res = await api.getCourses({ limit: 1000, status: 'active' });
                if (res.success) { allCourses = res.courses; applyFilters(); }
            } catch (e) { showToast('Failed to load', 'error'); }
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('coursesGrid').classList.remove('hidden');
        }

        function applyFilters() {
            filteredCourses = [...allCourses];
            if (filters.search) filteredCourses = filteredCourses.filter(c => c.title.toLowerCase().includes(filters.search) || (c.author && c.author.toLowerCase().includes(filters.search)));
            if (filters.category) filteredCourses = filteredCourses.filter(c => c.category === filters.category);
            if (filters.level) filteredCourses = filteredCourses.filter(c => c.level === filters.level);
            if (filters.price === 'free') filteredCourses = filteredCourses.filter(c => parseFloat(c.price) === 0);
            if (filters.price === 'paid') filteredCourses = filteredCourses.filter(c => parseFloat(c.price) > 0);

            switch (filters.sort) {
                case 'popular': filteredCourses.sort((a, b) => (b.total_students || 0) - (a.total_students || 0)); break;
                case 'price-low': filteredCourses.sort((a, b) => parseFloat(a.price) - parseFloat(b.price)); break;
                case 'price-high': filteredCourses.sort((a, b) => parseFloat(b.price) - parseFloat(a.price)); break;
                default: filteredCourses.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            }
            currentPage = 1;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            const start = (currentPage - 1) * limit;
            const pageData = filteredCourses.slice(start, start + limit);
            document.getElementById('resultsCount').textContent = `${filteredCourses.length} results`;
            renderCourses(pageData);
            updatePagination();
        }

        function renderCourses(courses) {
            const grid = document.getElementById('coursesGrid');
            if (!courses.length) { grid.innerHTML = ''; document.getElementById('emptyState').classList.remove('hidden'); return; }
            document.getElementById('emptyState').classList.add('hidden');

            grid.innerHTML = courses.map(c => {
                const hasDiscount = c.discount_price && parseFloat(c.discount_price) < parseFloat(c.price);
                const isOwned = purchasedIds.includes(c.id);
                const categoryLabel = { dev: 'Development', design: 'Design', marketing: 'Marketing' }[c.category] || c.category;

                return `
                <div class="card" style="position:relative;">
                    <div onclick="window.location.href='course.html?id=${c.id}'">
                        <button class="wishlist-btn ${favoriteIds.includes(c.id) ? 'active' : ''}" onclick="event.stopPropagation();toggleFavorite(${c.id},this)">${favoriteIds.includes(c.id) ? '♥' : '♡'}</button>
                        <img src="${c.image_url || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=400'}" class="card-img" onerror="this.src='https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=400'">
                        <div class="card-body">
                            <h3 class="card-title">${escapeHtml(c.title)}</h3>
                            <p class="card-instructor">${escapeHtml(c.author || 'Instructor')}</p>
                            <p style="font-size:12px;color:var(--text-muted);margin-bottom:8px">${categoryLabel} · ${c.level} · ${c.duration || 0}h</p>
                            <div class="card-price">
                                <span class="price-current">${hasDiscount ? '$' + parseFloat(c.discount_price).toFixed(2) : (parseFloat(c.price) === 0 ? 'Free' : '$' + parseFloat(c.price).toFixed(2))}</span>
                                ${hasDiscount ? `<span class="price-original">$${parseFloat(c.price).toFixed(2)}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredCourses.length / limit);
            const pagination = document.getElementById('pagination');
            if (totalPages <= 1) { pagination.classList.add('hidden'); return; }
            pagination.classList.remove('hidden');
            document.getElementById('paginationInfo').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        async function toggleFavorite(id, btn) {
            if (!localStorage.getItem('token')) { showToast('Please log in first', 'error'); return window.location.href = 'login.html'; }
            try {
                if (favoriteIds.includes(id)) { await api.removeFavorite(id); favoriteIds = favoriteIds.filter(i => i !== id); btn.innerHTML = '♡'; btn.classList.remove('active'); }
                else { await api.addFavorite(id); favoriteIds.push(id); btn.innerHTML = '♥'; btn.classList.add('active'); showToast('Added to wishlist'); }
            } catch (e) { showToast('Failed', 'error'); }
        }

        async function buyCourse(id) {
            if (!localStorage.getItem('token')) {
                showToast('Please log in to purchase', 'error');
                return window.location.href = 'login.html';
            }

            const course = allCourses.find(c => c.id === id);
            if (!course) return;

            const price = course.discount_price || course.price;
            const priceText = parseFloat(price) === 0 ? 'Free' : '$' + parseFloat(price).toFixed(2);

            if (confirm(`Purchase "${course.title}" for ${priceText}?`)) {
                const btn = document.getElementById(`buy-btn-${id}`);
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Processing...';
                }

                try {
                    const res = await api.purchaseCourse(id);
                    if (res.success) {
                        purchasedIds.push(id);
                        updateCartBadge();
                        showToast('Course added to My Learning!');

                        if (btn) {
                            btn.className = 'add-to-cart-btn owned';
                            btn.textContent = 'Go to course';
                            btn.disabled = false;
                            btn.onclick = () => window.location.href = `course.html?id=${id}`;
                        }
                    } else {
                        showToast(res.message || 'Purchase failed', 'error');
                        if (btn) { btn.disabled = false; btn.textContent = 'Buy now'; }
                    }
                } catch (e) {
                    showToast('Purchase failed', 'error');
                    if (btn) { btn.disabled = false; btn.textContent = 'Buy now'; }
                }
            }
        }
    </script>
</body>

</html>
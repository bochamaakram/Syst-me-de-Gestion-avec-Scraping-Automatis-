<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses | knowway</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .manage-hero {
            background: linear-gradient(135deg, var(--surface0) 0%, var(--crust) 100%);
        }

        .manage-hero h1 {
            color: var(--text);
        }

        .manage-hero p {
            color: var(--subtext0);
            margin-top: var(--space-sm);
        }

        .courses-list {
            margin-top: var(--space-lg);
        }

        .course-manage-item {
            display: flex;
            gap: var(--space-md);
            padding: var(--space-md);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-sm);
            align-items: center;
        }

        .course-manage-item img {
            width: 120px;
            height: 68px;
            object-fit: cover;
            border-radius: var(--radius-sm);
        }

        .course-manage-item-info {
            flex: 1;
        }

        .course-manage-item-title {
            font-weight: 600;
            margin-bottom: var(--space-xs);
        }

        .course-manage-item-meta {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .course-manage-item-actions {
            display: flex;
            gap: var(--space-sm);
        }

        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
        }

        @media (max-width: 900px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">knowway</a>
            <ul class="navbar-nav">
                <li><a href="hub.html">Explore</a></li>
                <li><a href="index.html">My Learning</a></li>
            </ul>
            <div class="navbar-user" id="navbarUser"></div>
        </div>
    </nav>

    <div id="loadingState" class="empty-state">
        <div class="spinner"></div>
    </div>

    <div id="accessDenied" class="access-denied hidden">
        <h2>Access Denied</h2>
        <p>Only teachers and admins can create courses.</p>
        <a href="index.html" class="btn btn-primary btn-lg">Go to Home</a>
    </div>

    <div id="mainContent" class="hidden">
        <section class="manage-hero hero">
            <div class="container">
                <h1>Manage Courses</h1>
                <p>Create and edit your courses</p>
            </div>
        </section>

        <main class="container">
            <div class="two-col">
                <!-- Course Form -->
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title" id="formTitle">Create New Course</h2>
                    </div>
                    <form id="courseForm">
                        <input type="hidden" id="courseId" value="">

                        <div class="form-group">
                            <label class="form-label">Title *</label>
                            <input type="text" id="title" class="form-control" placeholder="Course title" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Short Description</label>
                            <input type="text" id="shortDescription" class="form-control"
                                placeholder="Brief description for cards">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Full Description</label>
                            <textarea id="description" class="form-control" rows="4"
                                placeholder="Detailed course description"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Category</label>
                                <select id="category" class="form-control">
                                    <option value="dev">Development</option>
                                    <option value="design">Design</option>
                                    <option value="marketing">Marketing</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Level</label>
                                <select id="level" class="form-control">
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Price ($)</label>
                                <input type="number" id="price" class="form-control" value="0" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Duration (hours)</label>
                                <input type="number" id="duration" class="form-control" value="1" min="0">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Image URL</label>
                            <input type="url" id="imageUrl" class="form-control" placeholder="https://...">
                        </div>

                        <div class="form-group">
                            <label class="form-label">What You'll Learn (one per line)</label>
                            <textarea id="whatYouLearn" class="form-control" rows="3"
                                placeholder="Learn React basics&#10;Build real projects&#10;Master hooks"></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Requirements (one per line)</label>
                            <textarea id="requirements" class="form-control" rows="2"
                                placeholder="Basic JavaScript&#10;Computer with internet"></textarea>
                        </div>

                        <div style="display: flex; gap: var(--space-sm);">
                            <button type="submit" class="btn btn-primary" id="submitBtn">Create Course</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancel</button>
                        </div>
                    </form>
                </div>

                <!-- My Courses List -->
                <div class="panel">
                    <div class="panel-header">
                        <h2 class="panel-title">My Courses</h2>
                    </div>
                    <div id="myCoursesList" class="courses-list">
                        <div class="empty-state">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toastContainer" class="toast-container"></div>
    <script src="app.js"></script>
    <script>
        let myCourses = [];
        let editingCourse = null;

        document.addEventListener('DOMContentLoaded', async () => {
            updateNavbar();
            await checkAccess();
        });

        function updateNavbar() {
            const user = JSON.parse(localStorage.getItem('user'));
            document.getElementById('navbarUser').innerHTML = user
                ? `<a href="dashboard.html"><button class="btn btn-sm" style="background:var(--primary);color:var(--crust);width:40px;height:40px;border-radius:var(--radius-full);font-weight:700;">${user.username.charAt(0).toUpperCase()}</button></a>`
                : `<a href="login.html" class="btn btn-secondary btn-sm">Log in</a>`;
        }

        async function checkAccess() {
            if (!localStorage.getItem('token')) {
                window.location.href = 'login.html';
                return;
            }

            try {
                const roleRes = await api.getMyRole();
                if (!roleRes.success || (roleRes.role !== 'super_admin' && roleRes.role !== 'teacher')) {
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('accessDenied').classList.remove('hidden');
                    return;
                }

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                await loadMyCourses();
                setupForm();
            } catch (e) {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('accessDenied').classList.remove('hidden');
            }
        }

        async function loadMyCourses() {
            try {
                const res = await api.getCourses({ limit: 100 });
                if (res.success) {
                    const user = JSON.parse(localStorage.getItem('user'));
                    myCourses = res.courses.filter(c => c.user_id === user.id);
                    renderMyCourses();
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderMyCourses() {
            const container = document.getElementById('myCoursesList');
            if (myCourses.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No courses yet. Create your first course!</p></div>';
                return;
            }

            container.innerHTML = myCourses.map(c => `
                <div class="course-manage-item">
                    <img src="${c.image_url || 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=200'}" onerror="this.src='https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=200'">
                    <div class="course-manage-item-info">
                        <div class="course-manage-item-title">${escapeHtml(c.title)}</div>
                        <div class="course-manage-item-meta">${c.category} · ${c.level} · $${parseFloat(c.price).toFixed(2)}</div>
                    </div>
                    <div class="course-manage-item-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editCourse(${c.id})">Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteCourse(${c.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function setupForm() {
            document.getElementById('courseForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const courseData = {
                    title: document.getElementById('title').value,
                    short_description: document.getElementById('shortDescription').value,
                    description: document.getElementById('description').value,
                    category: document.getElementById('category').value,
                    level: document.getElementById('level').value,
                    price: parseFloat(document.getElementById('price').value) || 0,
                    duration: parseInt(document.getElementById('duration').value) || 0,
                    image_url: document.getElementById('imageUrl').value,
                    what_you_learn: document.getElementById('whatYouLearn').value,
                    requirements: document.getElementById('requirements').value
                };

                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = editingCourse ? 'Updating...' : 'Creating...';

                try {
                    let res;
                    if (editingCourse) {
                        res = await api.updateCourse(editingCourse.id, courseData);
                    } else {
                        res = await api.createCourse(courseData);
                    }

                    if (res.success) {
                        showToast(editingCourse ? 'Course updated!' : 'Course created!');
                        resetForm();
                        await loadMyCourses();
                    } else {
                        showToast(res.message || 'Failed', 'error');
                    }
                } catch (e) {
                    showToast('Error saving course', 'error');
                }

                submitBtn.disabled = false;
                submitBtn.textContent = editingCourse ? 'Update Course' : 'Create Course';
            });
        }

        function editCourse(id) {
            const course = myCourses.find(c => c.id === id);
            if (!course) return;

            editingCourse = course;
            document.getElementById('formTitle').textContent = 'Edit Course';
            document.getElementById('submitBtn').textContent = 'Update Course';
            document.getElementById('courseId').value = course.id;
            document.getElementById('title').value = course.title || '';
            document.getElementById('shortDescription').value = course.short_description || '';
            document.getElementById('description').value = course.description || '';
            document.getElementById('category').value = course.category || 'dev';
            document.getElementById('level').value = course.level || 'beginner';
            document.getElementById('price').value = course.price || 0;
            document.getElementById('duration').value = course.duration || 0;
            document.getElementById('imageUrl').value = course.image_url || '';
            document.getElementById('whatYouLearn').value = course.what_you_learn || '';
            document.getElementById('requirements').value = course.requirements || '';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            editingCourse = null;
            document.getElementById('formTitle').textContent = 'Create New Course';
            document.getElementById('submitBtn').textContent = 'Create Course';
            document.getElementById('courseForm').reset();
            document.getElementById('courseId').value = '';
        }

        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course?')) return;

            try {
                const res = await api.deleteCourse(id);
                if (res.success) {
                    showToast('Course deleted');
                    await loadMyCourses();
                } else {
                    showToast(res.message || 'Failed to delete', 'error');
                }
            } catch (e) {
                showToast('Error deleting course', 'error');
            }
        }
    </script>
</body>

</html>